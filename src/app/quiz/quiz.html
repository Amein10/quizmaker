<div class="page">
  <div class="card">
    <header class="top">
      <div class="title">üß© Quizmaker</div>
      <div class="spacer"></div>

      <!-- Builder toggle -->
      <button class="chip" (click)="showBuilder = !showBuilder" aria-expanded="{{showBuilder}}">
        üõ†Ô∏è Opret quiz
      </button>

      <!-- Navn + tema -->
      <input class="name" type="text" placeholder="Dit navn‚Ä¶"
             [value]="playerName"
             (input)="onNameChange($any($event.target).value)" aria-label="Dit navn" />
      <button class="theme" (click)="toggleTheme()" [attr.aria-label]="'Skift til ' + (theme==='dark'?'lys':'m√∏rk')">
        <span *ngIf="theme==='dark'">‚òÄÔ∏è</span>
        <span *ngIf="theme==='light'">üåô</span>
      </button>
    </header>

    <!-- ===== BUILDER ===== -->
    <section class="builder" *ngIf="showBuilder">
      <h4>Opret quiz</h4>
      <div class="form">
        <label>Sp√∏rgsm√•l
          <input type="text" [(ngModel)]="newQ.question" />
        </label>
        <div class="row">
          <label>Kategori
            <input type="text" [(ngModel)]="newQ.category" list="cats" />
            <datalist id="cats">
              <option *ngFor="let c of categories; trackBy: trackCategory" [value]="c"></option>
            </datalist>
          </label>
          <label>Sv√¶rhedsgrad
            <select [(ngModel)]="newQ.difficulty">
              <option *ngFor="let d of difficulties; trackBy: trackDifficulty">{{ d }}</option>
            </select>
          </label>
        </div>
        <label>Valgfri billede-URL
          <input type="text" [(ngModel)]="newQ.img" placeholder="https://..." />
        </label>

        <!-- Under-overskrift for sektion -->
        <div class="subtle-head">Sp√∏rgsm√•l & svar</div>

        <div class="answers">
          <div class="ans" *ngFor="let a of newQ.answers; index as i">
            <input type="text" [(ngModel)]="a.text" placeholder="Svartekst" />

            <!-- radio + tekst: forbedret klikomr√•de og layout -->
            <label class="check">
            <input type="radio" name="correct" [checked]="a.isCorrect" (change)="setCorrect(i)" />
            <span>Korrekt</span>
            </label>

            <button class="danger" (click)="removeAnswer(i)" *ngIf="newQ.answers.length > 2" aria-label="Fjern svar">‚úñ</button>
          </div>
          <button class="chip" (click)="addAnswer()">+ Tilf√∏j svarmulighed</button>
        </div>

        <div class="builder-actions">
          <button class="next" (click)="saveNewQuestion()">Tilf√∏j sp√∏rgsm√•l</button>
          <button class="ghost" (click)="showBuilder=false">Luk</button>
        </div>
      </div>
    </section>

    <!-- ===== FILTRE ===== -->
    <div class="filters">
      <div class="group">
        <div class="label">Kategori</div>
        <div class="chips">
          <button *ngFor="let c of categories; trackBy: trackCategory" class="chip"
                  [class.active]="c === selectedCategory"
                  (click)="setCategory(c)">{{ c }}</button>
        </div>
      </div>
      <div class="group">
        <div class="label">Sv√¶rhedsgrad</div>
        <div class="chips">
          <button *ngFor="let d of difficulties; trackBy: trackDifficulty" class="chip diff"
                  [class.active]="d === selectedDifficulty"
                  [attr.data-diff]="d"
                  (click)="setDifficulty(d)">{{ d }}</button>
        </div>
      </div>
    </div>

    <div class="meta">
      Sp√∏rgsm√•l {{ total ? (currentQuestionIndex + (answered ? 1 : 0)) : 0 }} / {{ total }}
    </div>
    <div class="progress" role="progressbar" [attr.aria-valuenow]="progressPct" aria-valuemin="0" aria-valuemax="100">
      <div class="bar" [style.width.%]="progressPct"></div>
    </div>

    <!-- Timer -->
    <div class="timer" *ngIf="total > 0 && !finished" aria-live="off">
      <div class="tbar" [style.width.%]="timePct"></div>
      <span class="tlabel">‚è±Ô∏è {{ timeLeft }}s</span>
    </div>

    <main class="content" *ngIf="total > 0 && !finished; else finishedBlock">
      <div class="fade" [class.in]="fade">
        <h2 class="question">{{ q.question }}</h2>
        <img *ngIf="q.img" [src]="q.img" alt="" class="q-img" />

        <ul class="options">
          <li *ngFor="let a of q.answers; index as i; trackBy: trackAnswer">
            <button class="opt"
                    [class.correct]="answered && a.isCorrect"
                    [class.wrong]="answered && selectedIndex === i && !a.isCorrect"
                    [class.pressed]="!answered && selectedIndex === i"
                    [disabled]="answered"
                    (click)="selectAnswer(i)">
              <ng-container *ngIf="a.img"><img [src]="a.img" alt="" class="opt-img" /></ng-container>
              <ng-container *ngIf="a.icon && !a.img"><span class="opt-icon">{{ a.icon }}</span></ng-container>
              <span>{{ a.text }}</span>
            </button>
          </li>
        </ul>

        <div class="feedback" *ngIf="answered" aria-live="polite">
          <span *ngIf="selectedIndex !== null && q.answers[selectedIndex!].isCorrect" class="ok">‚úÖ Korrekt!</span>
          <span *ngIf="selectedIndex === null || !q.answers[selectedIndex!].isCorrect" class="bad">
            <ng-container *ngIf="selectedIndex === null">‚è±Ô∏è Tiden l√∏b ud. </ng-container>
            Rigtigt svar er <strong>{{ correctAnswerText }}</strong>.
          </span>
        </div>

        <div class="actions">
          <button #nextBtn class="next" (click)="nextQuestion()" *ngIf="!isLast">N√¶ste</button>
        </div>
      </div>
    </main>

    <ng-template #finishedBlock>
      <div class="result fade in">
        <h3 *ngIf="total > 0; else noQs">üéâ Du har gennemf√∏rt quizzen!</h3>
        <p *ngIf="total > 0">Score: <strong>{{ score }}</strong> / {{ total }} ‚Äî <strong>{{ percentScore }}%</strong></p>
        <button *ngIf="total > 0" class="next" (click)="restart()">Pr√∏v igen</button>

        <ng-template #noQs>
          <h3>Ingen sp√∏rgsm√•l matcher dine filtre.</h3>
          <p>V√¶lg en anden kombination af kategori og sv√¶rhedsgrad.</p>
        </ng-template>

        <!-- OPSUMMERING -->
        <div class="summary" *ngIf="summary.length">
          <h4>üìù Opsummering</h4>
          <ol>
            <li *ngFor="let s of summary; index as i" [class.ok]="s.wasCorrect" [class.bad]="!s.wasCorrect">
              <div class="qline"><span class="badge">{{ i + 1 }}</span><span class="qtxt">{{ s.q }}</span></div>
              <div class="aline">
                <span *ngIf="s.selectedIndex !== null; else noA">Dit svar: <strong>{{ s.answers[s.selectedIndex!].text }}</strong></span>
                <ng-template #noA>Dit svar: <em>intet (tiden l√∏b ud)</em></ng-template>
              </div>
              <div class="cline">
                Korrekt: <strong>{{ s.answers[s.correctIndex].text }}</strong>
                <span class="status" *ngIf="s.wasCorrect">‚úÖ</span>
                <span class="status" *ngIf="!s.wasCorrect">‚ùå</span>
              </div>
            </li>
          </ol>
        </div>

        <!-- GRAF: tid pr. sp√∏rgsm√•l (simpel SVG-bar chart) -->
        <div class="chart" *ngIf="runTimes.length">
          <h4>‚è±Ô∏è Tid pr. sp√∏rgsm√•l</h4>
          <svg [attr.viewBox]="'0 0 ' + (runTimes.length*20 + 20) + ' 120'">
            <g *ngFor="let t of runTimes; index as i">
              <text [attr.x]="i*20+15" y="115" text-anchor="middle" class="tick">{{ i+1 }}</text>
              <rect [attr.x]="i*20+10"
                    [attr.y]="100 - Math.min(100, (t / timerPerQuestion) * 100)"
                    width="12"
                    [attr.height]="Math.min(100, (t / timerPerQuestion) * 100)"
                    [attr.fill]="correctMap[i] ? 'var(--ok)' : 'var(--bad)'" />
            </g>
            <line x1="10" y1="100" [attr.x2]="runTimes.length*20+10" y2="100" stroke="var(--border)"/>
          </svg>
          <div class="chart-legend">
            <span class="dot ok"></span> Rigtigt
            <span class="dot bad"></span> Forkert / Timeout
          </div>
        </div>

        <!-- HIGHSCORES -->
        <div class="highscores" *ngIf="highscores.length">
          <h4>üèÜ Highscore ({{ selectedCategory }} / {{ selectedDifficulty }})</h4>
          <table>
            <thead><tr><th>#</th><th>Navn</th><th>Score</th><th>Procent</th><th>Dato</th></tr></thead>
            <tbody>
              <tr *ngFor="let e of highscores; index as i">
                <td>{{ i + 1 }}</td>
                <td>{{ e.name }}</td>
                <td>{{ e.score }} / {{ e.total }}</td>
                <td>{{ e.percent }}%</td>
                <td>{{ e.dateISO | date:'yyyy-MM-dd HH:mm' }}</td>
              </tr>
            </tbody>
          </table>
          <button class="danger" (click)="clearHighscores()">Nulstil highscore</button>
        </div>

        <!-- HISTORIK -->
        <div class="history" *ngIf="history.length">
          <h4>üìú Historik (seneste)</h4>
          <table>
            <thead><tr><th>Dato</th><th>Navn</th><th>Cat/Diff</th><th>Score</th><th>Procent</th></tr></thead>
            <tbody>
              <tr *ngFor="let h of history">
                <td>{{ h.dateISO | date:'yyyy-MM-dd HH:mm' }}</td>
                <td>{{ h.name }}</td>
                <td>{{ h.category }} / {{ h.difficulty }}</td>
                <td>{{ h.score }}/{{ h.total }}</td>
                <td>{{ h.percent }}%</td>
              </tr>
            </tbody>
          </table>
          <button class="danger" (click)="clearHistory()">Nulstil historik</button>
        </div>
      </div>
    </ng-template>
  </div>
</div>
